name: CI

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  test:
    name: Tests (PHP ${{ matrix.php-version }}, Laravel ${{ matrix.laravel }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        php-version: ['8.2', '8.3', '8.4']
        laravel: ['11.*', '12.*']

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php-version }}
          extensions: mbstring, intl, pdo, sqlite
          coverage: none

      - name: Cache Composer dependencies
        uses: actions/cache@v4
        with:
          path: ~/.composer/cache/files
          key: ${{ runner.os }}-php-${{ matrix.php-version }}-laravel-${{ matrix.laravel }}-${{ hashFiles('**/composer.json') }}
          restore-keys: |
            ${{ runner.os }}-php-${{ matrix.php-version }}-laravel-${{ matrix.laravel }}-
            ${{ runner.os }}-php-${{ matrix.php-version }}-

      - name: Require Laravel version
        run: composer require "illuminate/support:${{ matrix.laravel }}" "illuminate/cache:${{ matrix.laravel }}" "illuminate/http:${{ matrix.laravel }}" --no-update

      - name: Install dependencies
        run: composer update --no-interaction --prefer-dist --no-progress

      - name: PHPUnit
        run: vendor/bin/phpunit --coverage-clover=coverage.xml

      - name: PHPStan
        run: vendor/bin/phpstan analyse

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          files: coverage.xml
          flags: php${{ matrix.php-version }}-laravel${{ matrix.laravel }}

  lint:
    name: PHP-CS-Fixer (PHP 8.2)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, intl, pdo, sqlite
          coverage: none

      - name: Cache Composer dependencies
        uses: actions/cache@v4
        with:
          path: ~/.composer/cache/files
          key: ${{ runner.os }}-php-8.2-csfixer-${{ hashFiles('**/composer.json') }}
          restore-keys: |
            ${{ runner.os }}-php-8.2-csfixer-

      - name: Install dependencies
        run: composer update --no-interaction --prefer-dist --no-progress

      - name: Install PHP-CS-Fixer
        run: composer require --dev friendsofphp/php-cs-fixer --no-interaction --no-progress

      - name: Run PHP-CS-Fixer (dry run)
        run: vendor/bin/php-cs-fixer fix --dry-run --diff

  benchmark:
    name: Performance Benchmarks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.4'
          extensions: mbstring, intl, pdo, sqlite
          coverage: none

      - name: Cache Composer dependencies
        uses: actions/cache@v4
        with:
          path: ~/.composer/cache/files
          key: ${{ runner.os }}-php-8.4-benchmark-${{ hashFiles('**/composer.json') }}
          restore-keys: |
            ${{ runner.os }}-php-8.4-benchmark-

      - name: Install dependencies
        run: composer update --no-interaction --prefer-dist --no-progress

      - name: Run benchmarks with assertions
        run: vendor/bin/phpbench run --report=aggregate --progress=none

      - name: Run critical benchmarks (fail on regression)
        run: |
          vendor/bin/phpbench run \
            --filter="benchSimpleBooleanFlag|benchTypicalRequest|benchHeavyRequest" \
            --report=aggregate \
            --progress=none

  benchmark-compare:
    name: Benchmark Comparison (PR only)
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4

      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.4'
          extensions: mbstring, intl, pdo, sqlite
          coverage: none

      - name: Install dependencies
        run: composer update --no-interaction --prefer-dist --no-progress

      - name: Run benchmarks on PR branch
        run: |
          vendor/bin/phpbench run \
            --filter="benchSimpleBooleanFlag|benchTypicalRequest|benchHeavyRequest" \
            --report=aggregate \
            --tag=pr \
            --progress=none

      - name: Checkout base branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.base_ref }}
          clean: false

      - name: Run benchmarks on base branch
        run: |
          vendor/bin/phpbench run \
            --filter="benchSimpleBooleanFlag|benchTypicalRequest|benchHeavyRequest" \
            --report=aggregate \
            --tag=base \
            --progress=none

      - name: Compare benchmarks
        run: |
          echo "## Benchmark Comparison" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Comparing PR against base branch..." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          vendor/bin/phpbench report --ref=pr --ref=base --report=compare >> $GITHUB_STEP_SUMMARY 2>&1 || true
